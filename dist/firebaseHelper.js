"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.currentUserId=void 0,exports.fetchLastMsg=fetchLastMsg,exports.fetchMsgs=fetchMsgs,exports.fetchStatus=fetchStatus,exports.getUsers=getUsers,exports.loginUser=loginUser,exports.markReadLastMsg=markReadLastMsg,exports.registerUser=registerUser,exports.saveMsg=saveMsg,exports.signoutUser=signoutUser,exports.syncStatus=syncStatus;var _auth=require("firebase/auth"),_firestore=require("firebase/firestore"),_initializeFirebaseApp=require("./initializeFirebaseApp"),_database=require("firebase/database"),_excluded=["email","password"];function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _objectWithoutProperties(a,b){if(null==a)return{};var c,d,e=_objectWithoutPropertiesLoose(a,b);if(Object.getOwnPropertySymbols){var f=Object.getOwnPropertySymbols(a);for(d=0;d<f.length;d++)c=f[d],0<=b.indexOf(c)||Object.prototype.propertyIsEnumerable.call(a,c)&&(e[c]=a[c])}return e}function _objectWithoutPropertiesLoose(a,b){if(null==a)return{};var c,d,e={},f=Object.keys(a);for(d=0;d<f.length;d++)c=f[d],0<=b.indexOf(c)||(e[c]=a[c]);return e}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}var currentUserId=function(){var a;return null===(a=(0,_initializeFirebaseApp.getAuthObj)().currentUser)||void 0===a?void 0:a.uid};exports.currentUserId=currentUserId;var getUserDocRef=function(a){return(0,_firestore.doc)((0,_initializeFirebaseApp.getStoreObj)(),"users",a)};function syncStatus(){(0,_auth.onAuthStateChanged)((0,_initializeFirebaseApp.getAuthObj)(),function(b){if(b){var c=b.uid;a(c)}});var a=function(a){var b=(0,_database.ref)((0,_initializeFirebaseApp.getDbObj)(),"/status/"+a),c={state:"offline",last_changed:(0,_database.serverTimestamp)()},d={state:"online",last_changed:(0,_database.serverTimestamp)()},e=(0,_database.ref)((0,_initializeFirebaseApp.getDbObj)(),".info/connected");(0,_database.onValue)(e,function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function e(a){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!1!==a.val()){e.next=2;break}return e.abrupt("return");case 2:(0,_database.onDisconnect)(b).set(c).then(_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:(0,_database.set)(b,d);case 1:case"end":return a.stop();}},a)})));case 3:case"end":return e.stop();}},e)}));return function(){return a.apply(this,arguments)}}())}}function getUsers(a){var b=(0,_firestore.collection)((0,_initializeFirebaseApp.getStoreObj)(),"users"),c=(0,_firestore.query)(b,(0,_firestore.where)("uid","!=",currentUserId()));return(0,_firestore.onSnapshot)(c,function(b){var c=[];b.forEach(function(a){c.push(a.data())}),a(c)})}function registerUser(){return _registerUser.apply(this,arguments)}function _registerUser(){return _registerUser=_asyncToGenerator(regeneratorRuntime.mark(function b(a){var c,d,e,f,g,h,i;return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return c=a.email,d=a.password,e=_objectWithoutProperties(a,_excluded),c&&d||console.error("Email & Password required to register a Firebase user"),f=!1,g=null,b.prev=4,b.next=7,(0,_auth.fetchSignInMethodsForEmail)((0,_initializeFirebaseApp.getAuthObj)(),c);case 7:if(h=b.sent,!h.length){b.next=10;break}return b.abrupt("return",null);case 10:return b.next=12,(0,_auth.createUserWithEmailAndPassword)((0,_initializeFirebaseApp.getAuthObj)(),c,d);case 12:return i=b.sent,g=_objectSpread(_objectSpread({uid:i.user.uid,email:c},e),{},{createdAt:_firestore.Timestamp.fromDate(new Date),isOnline:!0}),b.next=16,(0,_firestore.setDoc)(getUserDocRef(i.user.uid),_objectSpread({},g));case 16:b.next=22;break;case 18:b.prev=18,b.t0=b["catch"](4),console.error("registerUser Firebase",b.t0),f=!0;case 22:if(f){b.next=24;break}return b.abrupt("return",g);case 24:return b.abrupt("return",null);case 25:case"end":return b.stop();}},b,null,[[4,18]])})),_registerUser.apply(this,arguments)}function loginUser(){return _loginUser.apply(this,arguments)}function _loginUser(){return _loginUser=_asyncToGenerator(regeneratorRuntime.mark(function c(a,b){var d,e,f;return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(a&&b||console.error("Email & Password required to Login a Firebase user"),!(0,_initializeFirebaseApp.getAuthObj)().currentUser){c.next=3;break}return c.abrupt("return",(0,_initializeFirebaseApp.getAuthObj)().currentUser);case 3:return c.prev=3,c.next=6,(0,_auth.signInWithEmailAndPassword)((0,_initializeFirebaseApp.getAuthObj)(),a,b);case 6:return d=c.sent,e=getUserDocRef(d.user.uid),c.next=10,(0,_firestore.updateDoc)(e,{isOnline:!0});case 10:return c.next=12,(0,_firestore.getDoc)(e);case 12:if(f=c.sent,!f.exists()){c.next=15;break}return c.abrupt("return",f.data());case 15:c.next=20;break;case 17:c.prev=17,c.t0=c["catch"](3),console.error("loginUser Firebase",c.t0);case 20:return c.abrupt("return",null);case 21:case"end":return c.stop();}},c,null,[[3,17]])})),_loginUser.apply(this,arguments)}function signoutUser(){return _signoutUser.apply(this,arguments)}function _signoutUser(){return _signoutUser=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,(0,_firestore.updateDoc)(getUserDocRef(currentUserId()),{isOnline:!1});case 3:return a.next=5,(0,_auth.signOut)((0,_initializeFirebaseApp.getAuthObj)());case 5:a.next=10;break;case 7:a.prev=7,a.t0=a["catch"](0),console.error("signoutUser Firebase",a.t0);case 10:case"end":return a.stop();}},a,null,[[0,7]])})),_signoutUser.apply(this,arguments)}var getMsgId=function(a){var b=currentUserId();return b>a?"".concat(b,"-").concat(a):"".concat(a,"-").concat(b)},getMsgRef=function(a){return(0,_firestore.collection)((0,_initializeFirebaseApp.getStoreObj)(),"messages",getMsgId(a),"chat")};function saveMsg(){return _saveMsg.apply(this,arguments)}function _saveMsg(){return _saveMsg=_asyncToGenerator(regeneratorRuntime.mark(function c(a,b){return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,(0,_firestore.addDoc)(getMsgRef(b),{text:a,from:currentUserId(),to:b,createdAt:_firestore.Timestamp.fromDate(new Date)});case 2:return c.next=4,(0,_firestore.setDoc)((0,_firestore.doc)((0,_initializeFirebaseApp.getStoreObj)(),"lastMsg",getMsgId(b)),{text:a,from:currentUserId(),to:b,createdAt:_firestore.Timestamp.fromDate(new Date),unread:!0});case 4:case"end":return c.stop();}},c)})),_saveMsg.apply(this,arguments)}function fetchMsgs(a,b){var c=(0,_firestore.query)(getMsgRef(a),(0,_firestore.orderBy)("createdAt","asc"));return(0,_firestore.onSnapshot)(c,function(a){var c=[];a.forEach(function(a){c.push(a.data())}),b(c)})}function fetchLastMsg(a,b){var c=(0,_firestore.doc)((0,_initializeFirebaseApp.getStoreObj)(),"lastMsg",getMsgId(a));return(0,_firestore.onSnapshot)(c,function(a){b(a.data())})}function markReadLastMsg(){return _markReadLastMsg.apply(this,arguments)}function _markReadLastMsg(){return _markReadLastMsg=_asyncToGenerator(regeneratorRuntime.mark(function b(a){var c,d;return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return c=getMsgId(a),b.next=3,(0,_firestore.getDoc)((0,_firestore.doc)((0,_initializeFirebaseApp.getStoreObj)(),"lastMsg",c));case 3:if(d=b.sent,!(d.data()&&d.data().from!==currentUserId())){b.next=7;break}return b.next=7,(0,_firestore.updateDoc)((0,_firestore.doc)((0,_initializeFirebaseApp.getStoreObj)(),"lastMsg",c),{unread:!1});case 7:case"end":return b.stop();}},b)})),_markReadLastMsg.apply(this,arguments)}function fetchStatus(a,b){var c=(0,_database.ref)((0,_initializeFirebaseApp.getDbObj)());(0,_database.get)((0,_database.child)(c,"/status/"+a.uid)).then(function(c){if(c.exists()){var d=c.val();b(a.isOnline&&"offline"!==d.state?"online":"offline")}else console.log("No data available")})}